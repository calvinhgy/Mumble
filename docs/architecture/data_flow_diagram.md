# 数据流程图

## 1. 系统上下文图

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  用户设备        │◄────►  Mumble应用     │◄────►  Mumble后端服务  │
│  (iPhone)       │     │  (Web App)      │     │  (API服务)      │
│                 │     │                 │     │                 │
└─────────────────┘     └────────┬────────┘     └────────┬────────┘
                                 │                       │
                                 │                       │
                        ┌────────▼────────┐     ┌────────▼────────┐
                        │                 │     │                 │
                        │  本地存储        │     │  MongoDB数据库   │
                        │  (IndexedDB)    │     │                 │
                        │                 │     │                 │
                        └─────────────────┘     └────────┬────────┘
                                                         │
                                                         │
                                               ┌─────────▼─────────┐
                                               │                   │
                                               │  外部服务          │
                                               │  - OpenAI API     │
                                               │  - 天气API        │
                                               │  - 地理位置API     │
                                               │                   │
                                               └───────────────────┘
```

## 2. 核心功能数据流

### 2.1 语音录制与处理流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│         │     │         │     │         │     │         │     │         │
│  用户    │────►│ 麦克风   │────►│ Web Audio│────►│ 音频处理 │────►│ 音频文件 │
│ 输入    │     │ 访问    │     │  API    │     │ 模块    │     │ (Blob)  │
│         │     │         │     │         │     │         │     │         │
└─────────┘     └─────────┘     └─────────┘     └─────────┘     └────┬────┘
                                                                     │
                                                                     ▼
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│         │     │         │     │         │     │         │     │         │
│ 语义    │◄────┤ 语音    │◄────┤ 音频上传 │◄────┤ API     │◄────┤ HTTP    │
│ 分析    │     │ 识别    │     │ 服务    │     │ 网关    │     │ 请求    │
│         │     │         │     │         │     │         │     │         │
└────┬────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
     │
     ▼
┌─────────┐
│         │
│ 文本    │
│ 结果    │
│         │
└─────────┘
```

### 2.2 环境数据收集流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│         │     │         │     │         │     │         │
│ 地理位置 │────►│ 位置    │────►│ 位置    │────►│ 位置    │
│ API     │     │ 数据    │     │ 解析    │     │ 信息    │
│         │     │         │     │         │     │         │
└─────────┘     └─────────┘     └─────────┘     └────┬────┘
                                                     │
                                                     ▼
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│         │     │         │     │         │     │         │
│ 天气    │────►│ 天气    │────►│ 天气    │────►│ 环境    │
│ API     │     │ 数据    │     │ 解析    │     │ 数据集  │
│         │     │         │     │         │     │         │
└─────────┘     └─────────┘     └─────────┘     └────┬────┘
                                                     │
┌─────────┐     ┌─────────┐     ┌─────────┐          │
│         │     │         │     │         │          │
│ 设备    │────►│ 时间    │────►│ 时间    │─────────►│
│ 时钟    │     │ 数据    │     │ 解析    │          │
│         │     │         │     │         │          │
└─────────┘     └─────────┘     └─────────┘          │
                                                     ▼
                                               ┌─────────┐
                                               │         │
                                               │ 环境    │
                                               │ 上下文  │
                                               │         │
                                               └─────────┘
```

### 2.3 图像生成流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│         │     │         │     │         │     │         │     │         │
│ 语音    │     │ 环境    │     │ 提示词  │     │ DALL-E  │     │ 图像    │
│ 文本    │─┐   │ 上下文  │─┐   │ 构建    │────►│ API     │────►│ 结果    │
│         │ │   │         │ │   │         │     │         │     │         │
└─────────┘ │   └─────────┘ │   └─────────┘     └─────────┘     └────┬────┘
            ▼               ▼                                         │
        ┌───────────────────┐                                         │
        │                   │                                         │
        │  提示词生成服务    │                                         │
        │                   │                                         │
        └───────────────────┘                                         │
                                                                      ▼
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│         │     │         │     │         │     │         │     │         │
│ 图像    │◄────┤ 图像    │◄────┤ 图像    │◄────┤ 图像    │◄────┤ 图像    │
│ 展示    │     │ 缓存    │     │ 存储    │     │ 处理    │     │ 下载    │
│         │     │         │     │         │     │         │     │         │
└─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
```

### 2.4 图库管理流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│         │     │         │     │         │     │         │     │         │
│ 用户    │────►│ 图库    │────►│ API     │────►│ 图库    │────►│ 数据库  │
│ 请求    │     │ 界面    │     │ 请求    │     │ 服务    │     │ 查询    │
│         │     │         │     │         │     │         │     │         │
└─────────┘     └─────────┘     └─────────┘     └─────────┘     └────┬────┘
                                                                     │
                                                                     ▼
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│         │     │         │     │         │     │         │     │         │
│ 图片    │◄────┤ 图片    │◄────┤ 响应    │◄────┤ 图像    │◄────┤ 图像    │
│ 展示    │     │ 渲染    │     │ 处理    │     │ 元数据  │     │ 数据    │
│         │     │         │     │         │     │         │     │         │
└─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
```

## 3. 数据存储模型

### 3.1 用户数据模型

```
┌───────────────────────────┐
│ User                      │
├───────────────────────────┤
│ _id: ObjectId             │
│ deviceId: String          │
│ createdAt: Date           │
│ lastActive: Date          │
│ preferences: {            │
│   imageStyle: String,     │
│   privacySettings: Object,│
│   notifications: Object   │
│ }                         │
└───────────────────────────┘
```

### 3.2 图像数据模型

```
┌───────────────────────────┐
│ Image                     │
├───────────────────────────┤
│ _id: ObjectId             │
│ userId: ObjectId          │
│ imageUrl: String          │
│ thumbnailUrl: String      │
│ createdAt: Date           │
│ audioText: String         │
│ promptText: String        │
│ environmentData: {        │
│   location: {             │
│     lat: Number,          │
│     lng: Number,          │
│     placeName: String     │
│   },                      │
│   weather: {              │
│     condition: String,    │
│     temperature: Number,  │
│     humidity: Number      │
│   },                      │
│   time: {                 │
│     timestamp: Date,      │
│     timeOfDay: String     │
│   }                       │
│ }                         │
└───────────────────────────┘
```

### 3.3 环境数据模型

```
┌───────────────────────────┐
│ EnvironmentData           │
├───────────────────────────┤
│ _id: ObjectId             │
│ userId: ObjectId          │
│ timestamp: Date           │
│ location: {               │
│   coordinates: [Number],  │
│   placeName: String,      │
│   country: String,        │
│   administrativeArea: String │
│ }                         │
│ weather: {                │
│   condition: String,      │
│   temperature: Number,    │
│   humidity: Number,       │
│   windSpeed: Number,      │
│   pressure: Number        │
│ }                         │
│ time: {                   │
│   localTime: Date,        │
│   timeZone: String,       │
│   isDaylight: Boolean,    │
│   timeOfDay: String       │
│ }                         │
└───────────────────────────┘
```

## 4. API接口流程

### 4.1 录音上传与处理

```
┌─────────┐                                  ┌─────────┐
│         │                                  │         │
│ 客户端   │                                  │ 服务端   │
│         │                                  │         │
└────┬────┘                                  └────┬────┘
     │                                            │
     │  POST /api/audio                           │
     │  Content-Type: multipart/form-data         │
     │  Body: {audioFile, metadata}               │
     ├───────────────────────────────────────────►│
     │                                            │
     │                                            │ 处理音频
     │                                            │ 转换为文本
     │                                            │
     │  200 OK                                    │
     │  Body: {                                   │
     │    audioId: "...",                         │
     │    text: "...",                            │
     │    duration: 12.4                          │
     │  }                                         │
     │◄───────────────────────────────────────────┤
     │                                            │
```

### 4.2 环境数据提交

```
┌─────────┐                                  ┌─────────┐
│         │                                  │         │
│ 客户端   │                                  │ 服务端   │
│         │                                  │         │
└────┬────┘                                  └────┬────┘
     │                                            │
     │  POST /api/environment                     │
     │  Content-Type: application/json            │
     │  Body: {                                   │
     │    location: {lat, lng},                   │
     │    deviceData: {...}                       │
     │  }                                         │
     ├───────────────────────────────────────────►│
     │                                            │
     │                                            │ 获取天气数据
     │                                            │ 解析位置信息
     │                                            │ 处理时间数据
     │                                            │
     │  200 OK                                    │
     │  Body: {                                   │
     │    environmentId: "...",                   │
     │    enrichedData: {...}                     │
     │  }                                         │
     │◄───────────────────────────────────────────┤
     │                                            │
```

### 4.3 图像生成请求

```
┌─────────┐                                  ┌─────────┐
│         │                                  │         │
│ 客户端   │                                  │ 服务端   │
│         │                                  │         │
└────┬────┘                                  └────┬────┘
     │                                            │
     │  POST /api/images/generate                 │
     │  Content-Type: application/json            │
     │  Body: {                                   │
     │    audioId: "...",                         │
     │    environmentId: "...",                   │
     │    stylePreference: "..."                  │
     │  }                                         │
     ├───────────────────────────────────────────►│
     │                                            │
     │                                            │ 构建提示词
     │                                            │ 调用DALL-E API
     │                                            │ 处理图像结果
     │                                            │ 存储图像数据
     │                                            │
     │  202 Accepted                              │
     │  Body: {                                   │
     │    requestId: "...",                       │
     │    estimatedTime: 10                       │
     │  }                                         │
     │◄───────────────────────────────────────────┤
     │                                            │
     │                                            │
     │  GET /api/images/status/{requestId}        │
     ├───────────────────────────────────────────►│
     │                                            │
     │  200 OK                                    │
     │  Body: {                                   │
     │    status: "completed",                    │
     │    imageId: "...",                         │
     │    imageUrl: "..."                         │
     │  }                                         │
     │◄───────────────────────────────────────────┤
     │                                            │
```

### 4.4 图库查询流程

```
┌─────────┐                                  ┌─────────┐
│         │                                  │         │
│ 客户端   │                                  │ 服务端   │
│         │                                  │         │
└────┬────┘                                  └────┬────┘
     │                                            │
     │  GET /api/images                           │
     │  Query: {limit, offset, sortBy}            │
     ├───────────────────────────────────────────►│
     │                                            │
     │                                            │ 查询数据库
     │                                            │ 获取图像元数据
     │                                            │
     │  200 OK                                    │
     │  Body: {                                   │
     │    images: [...],                          │
     │    total: 42,                              │
     │    hasMore: true                           │
     │  }                                         │
     │◄───────────────────────────────────────────┤
     │                                            │
     │  GET /api/images/{imageId}                 │
     ├───────────────────────────────────────────►│
     │                                            │
     │  200 OK                                    │
     │  Body: {                                   │
     │    imageDetails: {...},                    │
     │    environmentData: {...},                 │
     │    audioText: "..."                        │
     │  }                                         │
     │◄───────────────────────────────────────────┤
     │                                            │
```
